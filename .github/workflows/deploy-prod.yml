name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (leave blank for latest staging version)'
        required: false
        type: string
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'deploy'
    steps:
      - name: Validate confirmation
        run: |
          echo "Production deployment confirmed"
          echo "Deploying to 2samples-prod..."

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::211125453069:role/GitHubActionsDeployRole
          aws-region: us-east-1

      - name: Get version to deploy
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Get the current version running on staging
            VERSION=$(aws elasticbeanstalk describe-environments \
              --environment-names 2samples-env \
              --query 'Environments[0].VersionLabel' --output text)
          fi
          echo "Deploying version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version exists
        run: |
          aws elasticbeanstalk describe-application-versions \
            --application-name 2samples-refactor \
            --version-labels "${{ steps.version.outputs.version }}" \
            --query 'ApplicationVersions[0].VersionLabel' --output text

      - name: Deploy to Production (2samples-prod)
        run: |
          aws elasticbeanstalk update-environment \
            --application-name 2samples-refactor \
            --environment-name 2samples-prod \
            --version-label "${{ steps.version.outputs.version }}"

      - name: Wait for Production Deployment
        run: |
          echo "Waiting for production environment to be ready..."
          aws elasticbeanstalk wait environment-updated \
            --application-name 2samples-refactor \
            --environment-names 2samples-prod

      - name: Verify Production Health
        run: |
          HEALTH=$(aws elasticbeanstalk describe-environment-health \
            --environment-name 2samples-prod \
            --attribute-names HealthStatus \
            --query 'HealthStatus' --output text)
          echo "Production environment health: $HEALTH"
          if [ "$HEALTH" = "Severe" ]; then
            echo "::error::Production deployment failed - environment health is Severe"
            exit 1
          fi
          echo "::notice::Production deployment successful! Version: ${{ steps.version.outputs.version }}"

  rejected:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'deploy'
    steps:
      - name: Deployment rejected
        run: |
          echo "::error::Deployment rejected. You must type 'deploy' to confirm."
          exit 1
